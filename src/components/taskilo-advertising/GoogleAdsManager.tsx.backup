'use client';

// üéØ GOOGLE ADS MANAGER - Component
// Spezialisierte Google Ads Verwaltung

import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { 
  TrendingUp, 
  Plus, 
  Settings, 
  ExternalLink,
  CheckCircle,
  XCircle,
  AlertTriangle 
} from 'lucide-react';

interface GoogleAdsManagerProps {
  companyId: string;
}

export default function GoogleAdsManager({ companyId }: GoogleAdsManagerProps) {
  const [isConnected, setIsConnected] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [connectionData, setConnectionData] = useState<any>(null);

  useEffect(() => {
    loadConnectionStatus();
  }, [companyId]);

  const loadConnectionStatus = async () => {
    console.log('üîç GoogleAdsManager: Loading connection status for company:', companyId);
    try {
      const response = await fetch(`/api/multi-platform-advertising/connections?companyId=${companyId}&platform=google-ads`);
      console.log('üì° API Response status:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        console.log('üìä Connection data received:', data);
        
        // Nur bei ECHTEN best√§tigten Verbindungen als connected setzen
        const hasConnection = data.success && data.connection;
        const isReallyConnected = hasConnection && data.connection.status === 'connected';
        const isPending = hasConnection && data.connection.status === 'pending_approval';
        
        console.log('üîó Connection analysis:', {
          hasConnection,
          isReallyConnected,
          isPending,
          status: data.connection?.status,
          customerId: data.connection?.customerId
        });
        
        setIsConnected(isReallyConnected || isPending); // Zeige UI f√ºr beide
        setConnectionData(hasConnection ? data.connection : null);
      } else {
        setIsConnected(false);
        setConnectionData(null);
      }
    } catch (error) {
      setIsConnected(false);
      setConnectionData(null);
    } finally {
      setIsLoading(false);
    }
  };

  const [customerId, setCustomerId] = useState('');
  const [isConnecting, setIsConnecting] = useState(false);

  const handleConnect = async () => {
    if (!customerId.trim()) {
      alert('Bitte Google Ads Customer ID eingeben');
      return;
    }

    console.log('üöÄ Starting Google Ads connection for Customer ID:', customerId.trim());
    setIsConnecting(true);
    try {
      const response = await fetch('/api/multi-platform-advertising/connections/connect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          companyId,
          platform: 'google-ads',
          customerId: customerId.trim()
        })
      });

      console.log('üì° Connect API Response:', response.status);

      if (response.ok) {
        const responseData = await response.json();
        console.log('‚úÖ Connection successful:', responseData);
        
        // WICHTIG: Status aus API Response verwenden, nicht hardcoden!
        setIsConnected(true);
        setConnectionData(responseData.connection || {
          status: 'pending_approval',
          customerId: customerId.trim(),
          connectedAt: new Date().toISOString()
        });
        setCustomerId('');
      } else {
        const error = await response.json();
        console.log('‚ùå Connection failed:', error);
        alert(`Fehler: ${error.message || 'Verbindung fehlgeschlagen'}`);
      }
    } catch (error) {
      console.error('üö® Google Ads connection failed:', error);
      alert('Verbindung fehlgeschlagen');
    } finally {
      setIsConnecting(false);
    }
  };

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div className="animate-pulse">
          <div className="h-32 bg-gray-200 rounded-lg mb-4"></div>
          <div className="h-48 bg-gray-200 rounded-lg"></div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Connection Status Card */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle className="flex items-center">
              <div className="p-2 rounded bg-blue-500 mr-3">
                <span className="text-white font-bold">G</span>
              </div>
              Google Ads Verbindung
            </CardTitle>
            <Badge variant={connectionData?.status === 'connected' ? "default" : connectionData?.status === 'pending_approval' ? "secondary" : "secondary"}>
              {connectionData?.status === 'connected' ? (
                <>
                  <CheckCircle className="w-4 h-4 mr-1 text-green-500" />
                  Verbunden
                </>
              ) : connectionData?.status === 'pending_approval' ? (
                <>
                  <AlertTriangle className="w-4 h-4 mr-1 text-orange-500" />
                  Warten auf Genehmigung
                </>
              ) : (
                <>
                  <XCircle className="w-4 h-4 mr-1 text-gray-400" />
                  Nicht verbunden
                </>
              )}
            </Badge>
          </div>
        </CardHeader>
        <CardContent>
          {isConnected ? (
            <div className="space-y-4">
              {connectionData?.status === 'pending_approval' ? (
                <div className="space-y-4">
                {/* AUTOMATISCHE ANBINDUNG */}
                <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center">
                      <CheckCircle className="w-5 h-5 text-blue-500 mr-2" />
                      <div>
                        <span className="text-blue-700 font-medium block">
                          Google Ads Konto: {connectionData.customerId}
                        </span>
                        <span className="text-blue-600 text-sm">
                          Bereit f√ºr automatische Anbindung
                        </span>
                      </div>
                    </div>
                    
                    <Button
                      onClick={async () => {
                        setIsConnecting(true);
                        console.log('üöÄ Starting automatic Google Ads connection...');
                        
                        try {
                          // API-Call f√ºr automatische Anbindung
                          const response = await fetch('/api/multi-platform-advertising/auto-connect', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                              companyId,
                              platform: 'google-ads',
                              customerId: connectionData.customerId,
                              autoConnect: true
                            })
                          });
                          
                          const result = await response.json();
                          console.log('üîó Auto-connect result:', result);
                          
                          if (result.success) {
                            setConnectionData({
                              ...connectionData,
                              status: 'connected',
                              connectedAt: new Date().toISOString(),
                              autoConnected: true
                            });
                            alert('‚úÖ Google Ads automatisch verbunden!\n\nIhr Konto ist jetzt mit unserem Manager verkn√ºpft.');
                          } else {
                            alert('‚ùå Automatische Verbindung fehlgeschlagen: ' + result.message);
                          }
                        } catch (error) {
                          console.error('üö® Auto-connect error:', error);
                          alert('‚ùå Verbindungsfehler');
                        } finally {
                          setIsConnecting(false);
                        }
                      }}
                      disabled={isConnecting}
                      className="bg-green-600 hover:bg-green-700 text-white"
                      size="sm"
                    >
                      {isConnecting ? (
                        <>üîÑ Verbinde...</>
                      ) : (
                        <>‚ö° Automatisch anbinden</>
                      )}
                    </Button>
                  </div>
                </div>
                        
                        <Button
                          onClick={async () => {
                            const confirmed = window.confirm(
                              `Haben Sie die Manager-Einladung bereits gesendet?\n\n` +
                              `Manager-ID: 578-822-9684\n` +
                              `Customer ID: ${connectionData.customerId}\n\n` +
                              `Klicken Sie OK, wenn die Einladung versendet wurde.`
                            );
                            
                            if (confirmed) {
                              console.log('üìß Marking invitation as sent manually');
                              
                              // Status auf "echte Einladung gesendet" setzen
                              const response = await fetch('/api/multi-platform-advertising/connections/status', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                  companyId,
                                  platform: 'google-ads',
                                  status: 'invitation_sent_manually',
                                  note: 'Manager-Einladung manuell √ºber Google Ads gesendet'
                                })
                              });
                              
                              if (response.ok) {
                                alert('‚úÖ Status aktualisiert: Einladung als gesendet markiert');
                                loadConnectionStatus();
                              }
                            }
                          }}
                          variant="outline"
                          size="sm"
                          className="border-green-500 text-green-600 hover:bg-green-50"
                        >
                          <CheckCircle className="w-4 h-4 mr-2" />
                          Einladung gesendet ‚úì
                        </Button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          ) : (
            <div className="space-y-4">
              <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-center">
                  <AlertTriangle className="w-5 h-5 text-blue-500 mr-2" />
                  <div>
                    <span className="text-blue-700 font-medium block">
                      Google Ads Konto verbinden
                    </span>
                    <span className="text-blue-600 text-sm">
                      Geben Sie Ihre Google Ads Customer ID ein
                    </span>
                  </div>
                </div>
              </div>
              
              <div className="space-y-4">
                <div className="p-3 bg-orange-50 border border-orange-200 rounded-lg">
                  <p className="text-orange-800 text-sm font-medium mb-2">üîó Verbindung mit Manager Account</p>
                  <p className="text-orange-700 text-xs">
                    Ihr Google Ads Konto wird mit dem Taskilo Manager Account (578-822-9684) verbunden. 
                    Sie erhalten eine E-Mail-Einladung zur Freigabe des Kontozugriffs.
                  </p>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-2">Ihre Google Ads Customer ID</label>
                  <input
                    type="text"
                    value={customerId}
                    onChange={(e) => setCustomerId(e.target.value)}
                    placeholder="z.B. 526-719-5046"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Ihre Customer ID finden Sie in Google Ads rechts oben im Account-Picker
                  </p>
                </div>
                
                <Button 
                  onClick={handleConnect} 
                  disabled={!customerId.trim() || isConnecting}
                  className="w-full bg-[#14ad9f] hover:bg-[#0f8a7e] text-white disabled:opacity-50"
                >
                  {isConnecting ? (
                    <>Sende Einladung...</>
                  ) : (
                    <>
                      <ExternalLink className="w-4 h-4 mr-2" />
                      Manager-Zugriff anfordern
                    </>
                  )}
                </Button>
              </div>
            
            <div className="text-sm text-gray-600">
              <p><strong>Was passiert beim Verbinden?</strong></p>
              <ul className="mt-2 space-y-1 list-disc list-inside">
                <li>Sie loggen sich in Ihr eigenes Google-Konto ein</li>
                <li>Google fragt nach Berechtigung f√ºr Taskilo</li>
                <li>Taskilo kann dann Ihre Kampagnen verwalten</li>
                <li>Ihre Daten bleiben in Ihrem Google-Konto</li>
              </ul>
              
              <p className="mt-3 text-xs text-gray-500">
                üîí Sicher: Taskilo erh√§lt nur Zugriff auf Google Ads, nicht auf andere Google-Dienste
              </p>
            </div>
            </div>
          )}
              
              {connectionData && (
                <div className="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
                  <p className="font-medium">Verbindungsdetails:</p>
                  <p>Verbunden am: {new Date(connectionData.connectedAt).toLocaleDateString('de-DE')}</p>
                  {connectionData.userInfo?.name && (
                    <p>Google-Konto: {connectionData.userInfo.name}</p>
                  )}
                </div>
              )}
              
              <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p className="text-yellow-700 text-sm">
                  ‚ÑπÔ∏è Kampagnen-Daten werden geladen, sobald die Google Ads API vollst√§ndig konfiguriert ist.
                </p>
              </div>
            </div>
          ) : (
            <div className="space-y-4">
              <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div className="flex items-center">
                  <AlertTriangle className="w-5 h-5 text-blue-500 mr-2" />
                  <div>
                    <span className="text-blue-700 font-medium block">
                      Google Ads Konto verbinden
                    </span>
                    <span className="text-blue-600 text-sm">
                      Geben Sie Ihre Google Ads Customer ID ein
                    </span>
                  </div>
                </div>
              </div>
              
              <div className="space-y-4">
                <div className="p-3 bg-orange-50 border border-orange-200 rounded-lg">
                  <p className="text-orange-800 text-sm font-medium mb-2">üîó Verbindung mit Manager Account</p>
                  <p className="text-orange-700 text-xs">
                    Ihr Google Ads Konto wird mit dem Taskilo Manager Account (578-822-9684) verbunden. 
                    Sie erhalten eine E-Mail-Einladung zur Freigabe des Kontozugriffs.
                  </p>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-2">Ihre Google Ads Customer ID</label>
                  <input
                    type="text"
                    value={customerId}
                    onChange={(e) => setCustomerId(e.target.value)}
                    placeholder="z.B. 526-719-5046"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Ihre Customer ID finden Sie in Google Ads rechts oben im Account-Picker
                  </p>
                </div>
                
                <Button 
                  onClick={handleConnect} 
                  disabled={!customerId.trim() || isConnecting}
                  className="w-full bg-[#14ad9f] hover:bg-[#0f8a7e] text-white disabled:opacity-50"
                >
                  {isConnecting ? (
                    <>Sende Einladung...</>
                  ) : (
                    <>
                      <ExternalLink className="w-4 h-4 mr-2" />
                      Manager-Zugriff anfordern
                    </>
                  )}
                </Button>
              </div>
            
            <div className="text-sm text-gray-600">
              <p><strong>Was passiert beim Verbinden?</strong></p>
              <ul className="mt-2 space-y-1 list-disc list-inside">
                <li>Sie loggen sich in Ihr eigenes Google-Konto ein</li>
                <li>Google fragt nach Berechtigung f√ºr Taskilo</li>
                <li>Taskilo kann dann Ihre Kampagnen verwalten</li>
                <li>Ihre Daten bleiben in Ihrem Google-Konto</li>
              </ul>
              
              <p className="mt-3 text-xs text-gray-500">
                üîí Sicher: Taskilo erh√§lt nur Zugriff auf Google Ads, nicht auf andere Google-Dienste
              </p>
            </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Quick Actions Card */}
      <Card>
        <CardHeader>
          <CardTitle>Schnellaktionen</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <Button 
              variant="outline" 
              className="h-16 flex items-center justify-start"
              disabled={!isConnected}
            >
              <Plus className="w-5 h-5 mr-3" />
              <div className="text-left">
                <div className="font-medium">Neue Kampagne</div>
                <div className="text-sm text-gray-500">Kampagne erstellen</div>
              </div>
            </Button>
            
            <Button 
              variant="outline" 
              className="h-16 flex items-center justify-start"
              disabled={!isConnected}
            >
              <TrendingUp className="w-5 h-5 mr-3" />
              <div className="text-left">
                <div className="font-medium">Performance</div>
                <div className="text-sm text-gray-500">Berichte anzeigen</div>
              </div>
            </Button>
            
            <Button 
              variant="outline" 
              className="h-16 flex items-center justify-start"
              disabled={!isConnected}
            >
              <Settings className="w-5 h-5 mr-3" />
              <div className="text-left">
                <div className="font-medium">Einstellungen</div>
                <div className="text-sm text-gray-500">Konto verwalten</div>
              </div>
            </Button>
            
            <Button 
              variant="outline" 
              className="h-16 flex items-center justify-start"
              disabled={!isConnected}
            >
              <ExternalLink className="w-5 h-5 mr-3" />
              <div className="text-left">
                <div className="font-medium">Google Ads √∂ffnen</div>
                <div className="text-sm text-gray-500">Externe Verwaltung</div>
              </div>
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}