rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper-Funktion, um Admin/Support-Rollen über Custom Claims zu prüfen.
    function isSupportStaff() {
      return request.auth != null && 
             request.auth.token != null &&
             ('role' in request.auth.token) &&
             (request.auth.token.role == 'master' || request.auth.token.role == 'support');
    }

    // Helper-Funktion, um erlaubte Dateitypen zu prüfen (nur für Uploads)
    function isValidImageType() {
      return request.resource != null &&
             request.resource.contentType != null &&
             (
               request.resource.contentType.matches('image/jpeg') ||
               request.resource.contentType.matches('image/jpg') ||
               request.resource.contentType.matches('image/png') ||
               request.resource.contentType.matches('image/webp') ||
               request.resource.contentType.matches('image/gif')
             );
    }

    // Helper-Funktion, um zu prüfen ob es sich um einen Upload oder Delete handelt
    function isUpload() {
      return request.resource != null;
    }

    function isDelete() {
      return request.resource == null && resource != null;
    }

    // Helper-Funktion für erlaubte Dokumenttypen
    function isValidDocumentType() {
      return request.resource != null &&
             request.resource.contentType != null &&
             (
               request.resource.contentType.matches('application/pdf') ||
               request.resource.contentType.matches('application/msword') ||
               request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
               request.resource.contentType.matches('image/jpeg') ||
               request.resource.contentType.matches('image/jpg') ||
               request.resource.contentType.matches('image/png') ||
               request.resource.contentType.matches('image/gif')
             );
    }

    // Helper-Funktion für Firmen-Berechtigungen
    function isCompany() {
      return request.auth != null && 
             request.auth.token != null &&
             ('role' in request.auth.token) &&
             request.auth.token.role == 'firma';
    }

    // Admins können jede Datei lesen. Dies ist entscheidend, damit das Admin-Dashboard Benutzerdokumente anzeigen kann.
    match /{allPaths=**} {
      allow read: if isSupportStaff();
    }

    // ÖFFENTLICHER LESEZUGRIFF für alle user_uploads (Firmenprofilbilder für Hero-Section und Anbietersuche)
    // Diese Regel muss VOR den spezifischeren Regeln stehen
    match /user_uploads/{userId}/{allPaths=**} {
      allow read: if true; // Öffentlicher Lesezugriff für alle user_uploads
      allow write: if request.auth != null && request.auth.uid == userId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Company Files (Banner, Logos etc.) - Firmen können ihre eigenen Dateien verwalten
    // Pfad: companies/{companyId}/{fileName} 
    // Diese Regel entspricht der companies collection in Firestore
    match /companies/{companyId}/{allPaths=**} {
      allow read: if true; // Öffentlicher Lesezugriff für Company-Dateien (Banner, Logos)
      allow write: if request.auth != null && request.auth.uid == companyId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Profilbilder - ein Benutzer kann seine eigenen Profilbilder lesen und schreiben.
    // Für Uploads: nur erlaubte Bildtypen. Für Löschen: alle Dateitypen erlaubt.
    // ÖFFENTLICHER LESEZUGRIFF für alle Profilbilder (für Hero-Section und Anbietersuche)
    match /profilePictures/{userId}/{allPaths=**} {
      allow read: if true; // Öffentlicher Lesezugriff für alle Profilbilder
      allow write: if request.auth != null && request.auth.uid == userId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Projektbilder - ein Benutzer kann seine eigenen Projektbilder lesen und schreiben.
    // Für Uploads: nur erlaubte Bildtypen. Für Löschen: alle Dateitypen erlaubt.
    match /projectImages/{userId}/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Mitarbeiter-Dokumente - Firmen können Dokumente ihrer Mitarbeiter verwalten
    // Pfad: employee_documents/{companyId}/{employeeId}/{category}/{fileName}
    match /employee_documents/{companyId}/{employeeId}/{category}/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      (isCompany() && request.auth.uid == companyId));
      allow write: if request.auth != null && 
                      (isSupportStaff() || 
                       (isCompany() && request.auth.uid == companyId)) &&
                      (isDelete() || (isUpload() && isValidDocumentType()));
    }

    // Workspace Task Anhänge - Authentifizierte Benutzer können Dateien zu Tasks hinzufügen
    // Pfad: workspaces/{workspaceId}/tasks/{taskId}/attachments/{fileName}
    match /workspaces/{workspaceId}/tasks/{taskId}/attachments/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      (isDelete() || (isUpload() && 
                       (isValidDocumentType() || 
                        request.resource.contentType.matches('text/.*') ||
                        request.resource.contentType.matches('application/.*'))));
    }

    // Fallback: Authentifizierte Benutzer können ihre eigenen Dateien in allen Pfaden lesen
    match /user_uploads/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }
    
    match /profilePictures/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    match /projectImages/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }
  }
}