rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper-Funktion, um Admin/Support-Rollen √ºber Custom Claims zu pr√ºfen.
    function isSupportStaff() {
      return request.auth != null && 
             request.auth.token != null &&
             ('role' in request.auth.token) &&
             (request.auth.token.role == 'master' || request.auth.token.role == 'support');
    }

    // Helper-Funktion, um erlaubte Dateitypen zu pr√ºfen (nur f√ºr Uploads)
    function isValidImageType() {
      return request.resource != null &&
             request.resource.contentType != null &&
             (
               request.resource.contentType.matches('image/jpeg') ||
               request.resource.contentType.matches('image/jpg') ||
               request.resource.contentType.matches('image/png') ||
               request.resource.contentType.matches('image/webp') ||
               request.resource.contentType.matches('image/gif')
             );
    }

    // Helper-Funktion, um zu pr√ºfen ob es sich um einen Upload oder Delete handelt
    function isUpload() {
      return request.resource != null;
    }

    function isDelete() {
      return request.resource == null && resource != null;
    }

    // Helper-Funktion f√ºr erlaubte Dokumenttypen
    function isValidDocumentType() {
      return request.resource != null &&
             request.resource.contentType != null &&
             (
               request.resource.contentType.matches('application/pdf') ||
               request.resource.contentType.matches('application/msword') ||
               request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document') ||
               request.resource.contentType.matches('image/jpeg') ||
               request.resource.contentType.matches('image/jpg') ||
               request.resource.contentType.matches('image/png') ||
               request.resource.contentType.matches('image/gif') ||
               request.resource.contentType.matches('image/heic') ||
               request.resource.contentType.matches('image/heif')
             );
    }

    // Helper-Funktion f√ºr Firmen-Berechtigungen
    function isCompany() {
      return request.auth != null && 
             request.auth.token != null &&
             ('role' in request.auth.token) &&
             request.auth.token.role == 'firma';
    }

    // Admins k√∂nnen jede Datei lesen. Dies ist entscheidend, damit das Admin-Dashboard Benutzerdokumente anzeigen kann.
    match /{allPaths=**} {
      allow read: if isSupportStaff();
    }

    // √ñFFENTLICHER LESEZUGRIFF f√ºr alle user_uploads (Firmenprofilbilder f√ºr Hero-Section und Anbietersuche)
    // Diese Regel muss VOR den spezifischeren Regeln stehen
    match /user_uploads/{userId}/{allPaths=**} {
      allow read: if true; // √ñffentlicher Lesezugriff f√ºr alle user_uploads
      allow write: if request.auth != null && request.auth.uid == userId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Company Files (Banner, Logos etc.) - Firmen k√∂nnen ihre eigenen Dateien verwalten
    // Pfad: companies/{companyId}/{fileName} 
    // Diese Regel entspricht der companies collection in Firestore
    match /companies/{companyId}/{allPaths=**} {
      allow read: if true; // √ñffentlicher Lesezugriff f√ºr Company-Dateien (Banner, Logos)
      allow write: if request.auth != null && request.auth.uid == companyId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Profilbilder - ein Benutzer kann seine eigenen Profilbilder lesen und schreiben.
    // F√ºr Uploads: nur erlaubte Bildtypen. F√ºr L√∂schen: alle Dateitypen erlaubt.
    // √ñFFENTLICHER LESEZUGRIFF f√ºr alle Profilbilder (f√ºr Hero-Section und Anbietersuche)
    match /profilePictures/{userId}/{allPaths=**} {
      allow read: if true; // √ñffentlicher Lesezugriff f√ºr alle Profilbilder
      allow write: if request.auth != null && request.auth.uid == userId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Projektbilder - ein Benutzer kann seine eigenen Projektbilder lesen und schreiben.
    // F√ºr Uploads: nur erlaubte Bildtypen. F√ºr L√∂schen: alle Dateitypen erlaubt.
    match /projectImages/{userId}/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId && 
                   (isDelete() || (isUpload() && isValidImageType()));
    }

    // Mitarbeiter-Dokumente - Firmen k√∂nnen Dokumente ihrer Mitarbeiter verwalten
    // Pfad: employee_documents/{companyId}/{employeeId}/{category}/{fileName}
    match /employee_documents/{companyId}/{employeeId}/{category}/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      (isCompany() && request.auth.uid == companyId));
      allow write: if request.auth != null && 
                      (isSupportStaff() || 
                       (isCompany() && request.auth.uid == companyId)) &&
                      (isDelete() || (isUpload() && isValidDocumentType()));
    }

    // Ausgaben-Belege - Firmen k√∂nnen ihre Rechnungsbelege verwalten
    // Pfad: expense-receipts/{companyId}/{fileName}
    match /expense-receipts/{companyId}/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      (isCompany() && request.auth.uid == companyId) ||
                      request.auth.uid == companyId);
      allow write: if request.auth != null && 
                      (isSupportStaff() || 
                       (isCompany() && request.auth.uid == companyId) ||
                       request.auth.uid == companyId) &&
                      (isDelete() || (isUpload() && 
                       request.resource.contentType.matches('application/pdf')));
    }

    // üéØ NEU: Expense Belege in Subcollection (moderner Pfad)
    // Pfad: companies/{companyId}/expenses/{fileName}
    match /companies/{companyId}/expenses/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      request.auth.uid == companyId);
      allow write: if request.auth != null && 
                      request.auth.uid == companyId &&
                      (isDelete() || (isUpload() && 
                       (request.resource.contentType.matches('application/pdf') ||
                        request.resource.contentType.matches('image/.*'))));
    }

    // üéØ NEU: Beleg-Uploads √ºber OCR-API (moderner Pfad)
    // Pfad: {companyId}/receipts/{fileName}
    match /{companyId}/receipts/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      request.auth.uid == companyId);
      allow write: if request.auth != null && 
                      request.auth.uid == companyId &&
                      (isDelete() || (isUpload() && isValidDocumentType()));
    }

    // Invoice PDFs - Firmen k√∂nnen ihre Rechnungs-PDFs verwalten
    // Pfad: invoices/{companyId}/{invoiceId}/{fileName}
    // WICHTIG: Diese Regel deckt auch Unterordner ab (z.B. actions/)
    match /invoices/{companyId}/{invoiceId}/{allPaths=**} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      (isCompany() && request.auth.uid == companyId) ||
                      request.auth.uid == companyId);
      allow write: if request.auth != null && 
                      (isSupportStaff() || 
                       (isCompany() && request.auth.uid == companyId) ||
                       request.auth.uid == companyId) &&
                      (isDelete() || (isUpload() && 
                       request.resource.contentType.matches('application/pdf')));
    }

    // Alternative Invoice PDF Pfad - f√ºr direkten Company-Zugriff
    // Pfad: invoices/{companyId}/{fileName}
    match /invoices/{companyId}/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      (isCompany() && request.auth.uid == companyId) ||
                      request.auth.uid == companyId);
      allow write: if request.auth != null && 
                      (isSupportStaff() || 
                       (isCompany() && request.auth.uid == companyId) ||
                       request.auth.uid == companyId) &&
                      (isDelete() || (isUpload() && 
                       request.resource.contentType.matches('application/pdf')));
    }

    // Portfolio-Bilder - Alle authentifizierten Benutzer k√∂nnen Portfolio-Bilder verwalten
    // Pfad: portfolio/{portfolioItemId}/main/{fileName} und portfolio/{portfolioItemId}/additional/{fileName}
    match /portfolio/{portfolioItemId}/{imageType}/{fileName} {
      allow read: if true; // Portfolio-Bilder sind √∂ffentlich lesbar
      allow write: if request.auth != null && // Jeder authentifizierte Benutzer kann uploaden
                      (isDelete() || (isUpload() && isValidImageType()));
    }

    // Alternative Portfolio-Pfade f√ºr Benutzer-spezifische Uploads
    // Pfad: portfolio/{userId}/{fileName}
    match /portfolio/{userId}/{fileName} {
      allow read: if true; // Portfolio-Bilder sind √∂ffentlich lesbar
      allow write: if request.auth != null && // Jeder authentifizierte Benutzer kann uploaden
                      (isDelete() || (isUpload() && isValidImageType()));
    }

    // Workspace Task Anh√§nge - Authentifizierte Benutzer k√∂nnen Dateien zu Tasks hinzuf√ºgen
    // Pfad: workspaces/{workspaceId}/tasks/{taskId}/attachments/{fileName}
    match /workspaces/{workspaceId}/tasks/{taskId}/attachments/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      (isDelete() || (isUpload() && 
                       (isValidDocumentType() || 
                        request.resource.contentType.matches('text/.*') ||
                        request.resource.contentType.matches('application/.*'))));
    }

    // Calendar Event Files - Firmen k√∂nnen Dateien zu ihren Kalenderereignissen hinzuf√ºgen
    // Pfad: companies/{companyId}/calendar_events/{eventId}/files/{fileName}
    match /companies/{companyId}/calendar_events/{eventId}/files/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      (isCompany() && request.auth.uid == companyId) ||
                      request.auth.uid == companyId);
      allow write: if request.auth != null && 
                      (isSupportStaff() || 
                       (isCompany() && request.auth.uid == companyId) ||
                       request.auth.uid == companyId) &&
                      (isDelete() || (isUpload() && 
                       (isValidDocumentType() || 
                        request.resource.contentType.matches('text/.*') ||
                        request.resource.contentType.matches('application/.*'))));
    }

    // Customer Documents - Firmen k√∂nnen Dokumente zu ihren Kunden hinzuf√ºgen
    // Pfad: companies/{companyId}/customers/{customerId}/documents/{fileName}
    match /companies/{companyId}/customers/{customerId}/documents/{fileName} {
      allow read: if request.auth != null && 
                     (isSupportStaff() || 
                      (isCompany() && request.auth.uid == companyId) ||
                      request.auth.uid == companyId);
      allow write: if request.auth != null && 
                      (isSupportStaff() || 
                       (isCompany() && request.auth.uid == companyId) ||
                       request.auth.uid == companyId) &&
                      (isDelete() || (isUpload() && 
                       (isValidDocumentType() || 
                        request.resource.contentType.matches('text/.*') ||
                        request.resource.contentType.matches('application/.*') ||
                        request.resource.contentType.matches('application/vnd.ms-excel') ||
                        request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'))));
    }

    // User Qualifications - Benutzer k√∂nnen ihre Zertifikate hochladen
    match /users/{userId}/qualifications/{fileName} {
      allow read: if request.auth != null && (request.auth.uid == userId || isSupportStaff());
      allow write: if request.auth != null && request.auth.uid == userId &&
                      (isDelete() || (isUpload() && isValidDocumentType()));
    }

    // User Certificates - Benutzer k√∂nnen ihre Zertifikate hochladen (f√ºr Experience Section)
    match /users/{userId}/certificates/{fileName} {
      allow read: if request.auth != null && (request.auth.uid == userId || isSupportStaff());
      allow write: if request.auth != null && request.auth.uid == userId &&
                      (isDelete() || (isUpload() && isValidDocumentType()));
    }

    // User Profile Pictures - Benutzer k√∂nnen ihre Profilbilder hochladen
    match /users/{userId}/profile_picture/{fileName} {
      allow read: if true; // √ñffentlich lesbar f√ºr Profilanzeige
      allow write: if request.auth != null && request.auth.uid == userId &&
                      (isDelete() || (isUpload() && isValidImageType()));
    }

    // Fallback: Authentifizierte Benutzer k√∂nnen ihre eigenen Dateien in allen Pfaden lesen
    match /user_uploads/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }
    
    match /profilePictures/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    match /projectImages/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }
  }
}