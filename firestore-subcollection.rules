// NEUE FIRESTORE RULES für Subcollection-Struktur
// Diese Rules ersetzen die alten globalen Collection-Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== GLOBAL COLLECTIONS (bleiben unverändert) =====
    
    // Users Collection
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Companies Collection
    match /companies/{companyId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Global Collections (für Admin-Analytics)
    match /auftraege/{auftragId} {
      allow read, write: if request.auth != null;
    }
    
    match /invoices/{invoiceId} {
      allow read, write: if request.auth != null;
    }
    
    match /categories/{categoryId} {
      allow read: if true; // Public read
      allow write: if request.auth != null;
    }
    
    match /reviews/{reviewId} {
      allow read: if true; // Public read
      allow write: if request.auth != null;
    }
    
    // System Collections
    match /admin_logs/{logId} {
      allow read, write: if request.auth != null; // Nur authentifizierte User
    }
    
    match /analytics/{analyticsId} {
      allow read, write: if request.auth != null;
    }
    
    match /ai_conversations/{conversationId} {
      allow read, write: if request.auth != null;
    }
    
    match /ai_learning_patterns/{patternId} {
      allow read, write: if request.auth != null;
    }
    
    // Communication (falls global)
    match /chats/{chatId} {
      allow read, write: if request.auth != null;
    }
    
    match /directChats/{chatId} {
      allow read, write: if request.auth != null;
    }
    
    match /supportChats/{chatId} {
      allow read, write: if request.auth != null;
    }
    
    // External Service Management
    match /finapi_disconnections/{disconnectionId} {
      allow read, write: if request.auth != null;
    }
    
    match /revolut_disconnections/{disconnectionId} {
      allow read, write: if request.auth != null;
    }
    
    // Payment & Stripe
    match /escrowPayments/{paymentId} {
      allow read, write: if request.auth != null;
    }
    
    match /stripe_cache/{cacheId} {
      allow read, write: if request.auth != null;
    }
    
    match /payout_logs/{payoutId} {
      allow read, write: if request.auth != null;
    }
    
    // System Collections
    match /numberSequences/{sequenceId} {
      allow read, write: if request.auth != null;
    }
    
    match /rate_limits/{limitId} {
      allow read, write: if request.auth != null;
    }
    
    match /textTemplates/{templateId} {
      allow read, write: if request.auth != null;
    }
    
    match /userPreferences/{preferenceId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== COMPANY SUBCOLLECTIONS (neue Struktur) =====
    
    // Basis-Rule für alle Company Subcollections
    match /companies/{companyId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Spezifische Rules für Company Subcollections
    
    // Customers Subcollection
    match /companies/{companyId}/customers/{customerId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
      
      // Nested subcollections within customers
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == companyId;
      }
    }
    
    // Inventory Subcollection
    match /companies/{companyId}/inventory/{itemId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Stock Movements Subcollection
    match /companies/{companyId}/stockMovements/{movementId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Time Entries Subcollection
    match /companies/{companyId}/timeEntries/{entryId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Quotes Subcollection
    match /companies/{companyId}/quotes/{quoteId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
      
      // Chat subcollection within quotes
      match /chat/{messageId} {
        allow read, write: if request.auth != null && request.auth.uid == companyId;
      }
    }
    
    // Expenses Subcollection
    match /companies/{companyId}/expenses/{expenseId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Order Time Tracking Subcollection
    match /companies/{companyId}/orderTimeTracking/{trackingId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Booking Accounts Subcollection (bereits existierend)
    match /companies/{companyId}/bookingAccounts/{accountId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // Notifications Subcollection
    match /companies/{companyId}/notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == companyId;
    }
    
    // ===== HELPER FUNCTIONS =====
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(companyId) {
      return request.auth != null && request.auth.uid == companyId;
    }
    
    function isValidCompanyData() {
      return request.resource.data.keys().hasAll(['name', 'email']) &&
             request.resource.data.name is string &&
             request.resource.data.email is string;
    }
    
    function isValidCustomerData() {
      return request.resource.data.keys().hasAll(['name']) &&
             request.resource.data.name is string;
    }
    
    // ===== ADMIN OVERRIDE (optional) =====
    
    // Admin users können alles lesen (für Support/Analytics)
    match /{document=**} {
      allow read: if request.auth != null && 
        request.auth.token.admin == true; // Custom claim
    }
  }
}

/*
MIGRATION CHECKLIST für Firestore Rules:

✅ Global Collections Rules beibehalten
✅ Company Subcollections Rules hinzugefügt  
✅ Basis-Wildcard-Rule für Company Subcollections
✅ Spezifische Rules für jede Subcollection
✅ Nested Subcollections berücksichtigt (z.B. quotes/chat)
❌ Tests für neue Rules schreiben
❌ Rules in Firebase Console deployen
❌ Funktionalität testen

DEPLOYMENT:
firebase deploy --only firestore:rules

TESTING:
firebase emulators:start --only firestore
# Test mit verschiedenen User-Rollen
*/